package http

import (
	"fmt"
	"os"
	"path/filepath"
	"strings"
	"text/template"
)

// ç”Ÿæˆå¯¼å…¥ä»£ç çš„æ¨¡æ¿ï¼ˆæ–°å¢æ—¥å¿—æç¤ºï¼‰
const routeImportTpl = `// Code generated by go-common auto-gen; DO NOT EDIT.
// è­¦å‘Šï¼šæ­¤æ–‡ä»¶ç”±go-commonè‡ªåŠ¨ç”Ÿæˆï¼Œåˆ é™¤/ä¿®æ”¹ä¼šå¯¼è‡´è·¯ç”±æ³¨å†Œå¤±æ•ˆï¼
package {{.PackageName}}

import (
{{range .Routes}}
	_ "{{.ModuleName}}/{{.Path}}"
{{end}}
)

// Init æ ¸å¿ƒå‡½æ•°ï¼šé˜²æ­¢ç¼–è¯‘å™¨ä¼˜åŒ–æ‰ä¸Šè¿°è·¯ç”±åŒ…çš„å¯¼å…¥
// ğŸ”´ é‡è¦æé†’ï¼šè¯·å‹¿åˆ é™¤/ä¿®æ”¹æ­¤å‡½æ•°ï¼
// ä½œç”¨ï¼šå³ä½¿æ²¡æœ‰å…¶ä»–ä»£ç å¼•ç”¨è¿™äº›è·¯ç”±åŒ…ï¼Œç¼–è¯‘å™¨ä¹Ÿä¼šä¿ç•™å¯¼å…¥ï¼Œè§¦å‘è·¯ç”±åŒ…çš„init()å‡½æ•°æ‰§è¡Œ
// åˆ é™¤åæœï¼šæ‰€æœ‰è·¯ç”±åŒ…çš„init()ä¸ä¼šæ‰§è¡Œï¼Œè·¯ç”±æ³¨å†Œå¤±æ•ˆï¼Œæ¥å£404
func Init() {
	// å¯åŠ¨æ—¶æ‰“å°æç¤ºï¼Œå¼ºåŒ–è®¤çŸ¥ï¼ˆä»…debugçº§åˆ«ï¼Œä¸å½±å“ç”Ÿäº§ï¼‰
	if true { // é¿å…ç¼–è¯‘å™¨ä¼˜åŒ–æ‰æ—¥å¿—ï¼ˆå®é™…å¯ç»“åˆlogçº§åˆ«æ§åˆ¶ï¼‰
		fmt.Printf("[è·¯ç”±è‡ªåŠ¨å¯¼å…¥] å·²åŠ è½½ %d ä¸ªè·¯ç”±åŒ…ï¼ŒInit()å‡½æ•°æ­£å¸¸ç”Ÿæ•ˆï¼ˆè¯·å‹¿åˆ é™¤æ­¤å‡½æ•°ï¼‰\n", len([]interface{}{ {{range .Routes}}nil,{{end}} }))
	}
}
`

// RouteGenInfo è·¯ç”±åŒ…ä¿¡æ¯
type RouteGenInfo struct {
	ModuleName string // ä¸šåŠ¡é¡¹ç›®çš„go moduleåï¼ˆå¦‚pano-materialï¼‰
	Path       string // è·¯ç”±åŒ…ç›¸å¯¹è·¯å¾„ï¼ˆå¦‚testã€lectureï¼‰
}

// RouteGenConfig ç”Ÿæˆé…ç½®
type RouteGenConfig struct {
	PackageName string         // ç”Ÿæˆæ–‡ä»¶çš„åŒ…åï¼ˆé»˜è®¤routesï¼‰
	Routes      []RouteGenInfo // æ‰«æåˆ°çš„è·¯ç”±åŒ…
}

// AutoGenRouteImport è‡ªåŠ¨ç”Ÿæˆè·¯ç”±å¯¼å…¥ä»£ç ï¼ˆæ”¯æŒé€šé…ç¬¦åŒ¹é…ï¼‰
// å‚æ•°è¯´æ˜ï¼š
// - moduleName: ä¸šåŠ¡é¡¹ç›®çš„go moduleåï¼ˆå¿…å¡«ï¼Œå¦‚pano-materialï¼‰
// - scanRoot: æ‰«æçš„æ ¹ç›®å½•ï¼ˆé»˜è®¤å½“å‰ç›®å½•ï¼Œä¼ ""åˆ™ç”¨å½“å‰å·¥ä½œç›®å½•ï¼‰
// - outputDir: ç”Ÿæˆæ–‡ä»¶çš„ç›®å½•ï¼ˆé»˜è®¤routesï¼‰
// - matchPatterns: é€šé…ç¬¦åŒ¹é…è§„åˆ™ï¼ˆé€—å·åˆ†éš”ï¼Œé»˜è®¤test,lecture,handler,*Route,*routerï¼‰
// - ignoreDirs: å¿½ç•¥çš„ç›®å½•å…³é”®è¯ï¼ˆé€—å·åˆ†éš”ï¼Œé»˜è®¤vendor,testdata,docsï¼‰
func AutoGenRouteImport(moduleName, scanRoot, outputDir, matchPatterns, ignoreDirs string) error {
	// 1. å‚æ•°é»˜è®¤å€¼å¤„ç†
	if scanRoot == "" {
		var err error
		scanRoot, err = os.Getwd() // è·å–å½“å‰å·¥ä½œç›®å½•
		if err != nil {
			return fmt.Errorf("è·å–å½“å‰ç›®å½•å¤±è´¥ï¼š%v", err)
		}
	}
	if outputDir == "" {
		outputDir = "routes" // é»˜è®¤ç”Ÿæˆåˆ°routesç›®å½•
	}
	// é»˜è®¤æ”¯æŒçš„é€šé…ç¬¦è§„åˆ™ï¼šç²¾ç¡®åŒ¹é…+æ¨¡ç³ŠåŒ¹é…
	if matchPatterns == "" {
		matchPatterns = "test,lecture,handler,*Route,*router,handler/*"
	}
	if ignoreDirs == "" {
		ignoreDirs = "vendor,testdata,docs,node_modules,.git,.idea"
	}
	if moduleName == "" {
		return fmt.Errorf("moduleNameä¸èƒ½ä¸ºç©ºï¼ˆè¯·ä¼ å…¥ä¸šåŠ¡é¡¹ç›®çš„go moduleåï¼Œå¦‚pano-materialï¼‰")
	}

	// 2. åˆ›å»ºroutesç›®å½•ï¼ˆä¸å­˜åœ¨åˆ™åˆ›å»ºï¼‰
	if err := os.MkdirAll(outputDir, 0755); err != nil {
		return fmt.Errorf("åˆ›å»ºroutesç›®å½•å¤±è´¥ï¼š%v", err)
	}

	// 3. è§£æåŒ¹é…è§„åˆ™ï¼ˆæ‹†åˆ†ä¸ºé€šé…ç¬¦åˆ—è¡¨ï¼‰
	matchList := strings.Split(matchPatterns, ",")
	// æ¸…ç†ç©ºè§„åˆ™
	for i := len(matchList) - 1; i >= 0; i-- {
		matchList[i] = strings.TrimSpace(matchList[i])
		if matchList[i] == "" {
			matchList = append(matchList[:i], matchList[i+1:]...)
		}
	}

	// 4. è§£æå¿½ç•¥ç›®å½•è§„åˆ™
	ignoreList := make(map[string]bool)
	for _, dir := range strings.Split(ignoreDirs, ",") {
		dir = strings.TrimSpace(dir)
		if dir != "" {
			ignoreList[dir] = true
		}
	}

	// 5. æ‰«æç›®å½•ï¼Œæ”¶é›†è·¯ç”±åŒ…ï¼ˆæ ¸å¿ƒï¼šé€šé…ç¬¦åŒ¹é…ï¼‰
	var routes []RouteGenInfo
	err := filepath.Walk(scanRoot, func(path string, info os.FileInfo, err error) error {
		if err != nil {
			return err
		}

		// è·³è¿‡éç›®å½•ã€æ ¹ç›®å½•ã€å¿½ç•¥ç›®å½•
		if !info.IsDir() || path == scanRoot || ignoreList[filepath.Base(path)] {
			return nil
		}

		// è·å–å½“å‰ç›®å½•çš„åŸºç¡€åï¼ˆå¦‚handler/user â†’ userï¼›orderRoute â†’ orderRouteï¼‰
		dirBase := filepath.Base(path)
		// è·å–å½“å‰ç›®å½•çš„å®Œæ•´ç›¸å¯¹è·¯å¾„ï¼ˆç”¨äºåŒ¹é…handler/*è¿™ç±»è·¯å¾„è§„åˆ™ï¼‰
		relPath, _ := filepath.Rel(scanRoot, path)
		// ç»Ÿä¸€è½¬ä¸ºæ–œæ ï¼ˆå…¼å®¹Windowsï¼‰
		relPath = filepath.ToSlash(relPath)

		// éå†æ‰€æœ‰åŒ¹é…è§„åˆ™ï¼Œåªè¦æ»¡è¶³ä¸€ä¸ªå°±è§†ä¸ºåŒ¹é…æˆåŠŸ
		matchSuccess := false
		for _, pattern := range matchList {
			// è§„åˆ™1ï¼šåŒ¹é…ç›®å½•åŸºç¡€åï¼ˆå¦‚*Routeã€*routerï¼‰
			if ok, _ := filepath.Match(pattern, dirBase); ok {
				matchSuccess = true
				break
			}
			// è§„åˆ™2ï¼šåŒ¹é…å®Œæ•´ç›¸å¯¹è·¯å¾„ï¼ˆå¦‚handler/*ï¼‰
			if ok, _ := filepath.Match(pattern, relPath); ok {
				matchSuccess = true
				break
			}
		}

		// åŒ¹é…æˆåŠŸåˆ™åŠ å…¥è·¯ç”±åˆ—è¡¨
		if matchSuccess {
			routes = append(routes, RouteGenInfo{
				ModuleName: moduleName,
				Path:       relPath,
			})
			fmt.Printf("[go-common] åŒ¹é…åˆ°è·¯ç”±åŒ…ï¼š%s/%s\n", moduleName, relPath)
		}
		return nil
	})
	if err != nil {
		return fmt.Errorf("æ‰«æè·¯ç”±ç›®å½•å¤±è´¥ï¼š%v", err)
	}

	// 6. ç”Ÿæˆå¯¼å…¥ä»£ç 
	config := RouteGenConfig{
		PackageName: filepath.Base(outputDir), // åŒ…åé»˜è®¤æ˜¯ç›®å½•åï¼ˆroutesï¼‰
		Routes:      routes,
	}
	tpl, err := template.New("routeImport").Parse(routeImportTpl)
	if err != nil {
		return fmt.Errorf("è§£ææ¨¡æ¿å¤±è´¥ï¼š%v", err)
	}

	// 7. å†™å…¥auto_import.goæ–‡ä»¶
	outputFile := filepath.Join(outputDir, "auto_import.go")
	f, err := os.Create(outputFile)
	if err != nil {
		return fmt.Errorf("åˆ›å»ºauto_import.goå¤±è´¥ï¼š%v", err)
	}
	defer f.Close()

	if err := tpl.Execute(f, config); err != nil {
		return fmt.Errorf("ç”Ÿæˆauto_import.goå†…å®¹å¤±è´¥ï¼š%v", err)
	}

	fmt.Printf("[go-common] æˆåŠŸç”Ÿæˆè·¯ç”±å¯¼å…¥æ–‡ä»¶ï¼š%sï¼ˆå…±%dä¸ªè·¯ç”±åŒ…ï¼‰\n", outputFile, len(routes))
	return nil
}

//package http
//
//import (
//	"fmt"
//	"os"
//	"path/filepath"
//	"text/template"
//)
//
//// ç”Ÿæˆå¯¼å…¥ä»£ç çš„æ¨¡æ¿
//const routeImportTpl = `// Code generated by go-common auto-gen; DO NOT EDIT.
//package {{.PackageName}}
//
//import (
//{{range .Routes}}
//	_ "{{.ModuleName}}/{{.Path}}"
//{{end}}
//)
//
//// Init ç©ºå‡½æ•°ï¼Œé˜²æ­¢ç¼–è¯‘å™¨ä¼˜åŒ–æ‰å¯¼å…¥
//func Init() {}
//`
//
//// RouteGenInfo è·¯ç”±åŒ…ä¿¡æ¯
//type RouteGenInfo struct {
//	ModuleName string // ä¸šåŠ¡é¡¹ç›®çš„go moduleåï¼ˆå¦‚pano-materialï¼‰
//	Path       string // è·¯ç”±åŒ…ç›¸å¯¹è·¯å¾„ï¼ˆå¦‚testã€lectureï¼‰
//}
//
//// RouteGenConfig ç”Ÿæˆé…ç½®
//type RouteGenConfig struct {
//	PackageName string         // ç”Ÿæˆæ–‡ä»¶çš„åŒ…åï¼ˆé»˜è®¤routesï¼‰
//	Routes      []RouteGenInfo // æ‰«æåˆ°çš„è·¯ç”±åŒ…
//}
//
//// AutoGenRouteImport è‡ªåŠ¨ç”Ÿæˆè·¯ç”±å¯¼å…¥ä»£ç ï¼ˆæ ¸å¿ƒå‡½æ•°ï¼‰
//// å‚æ•°è¯´æ˜ï¼š
//// - moduleName: ä¸šåŠ¡é¡¹ç›®çš„go moduleåï¼ˆå¿…å¡«ï¼Œå¦‚pano-materialï¼‰
//// - scanRoot: æ‰«æçš„æ ¹ç›®å½•ï¼ˆé»˜è®¤å½“å‰ç›®å½•ï¼Œä¼ ""åˆ™ç”¨å½“å‰å·¥ä½œç›®å½•ï¼‰
//// - outputDir: ç”Ÿæˆæ–‡ä»¶çš„ç›®å½•ï¼ˆé»˜è®¤routesï¼‰
//// - matchDirs: éœ€è¦æ‰«æçš„ç›®å½•å…³é”®è¯ï¼ˆé€—å·åˆ†éš”ï¼Œé»˜è®¤test,lecture,handlerï¼‰
//// - ignoreDirs: å¿½ç•¥çš„ç›®å½•å…³é”®è¯ï¼ˆé€—å·åˆ†éš”ï¼Œé»˜è®¤vendor,testdata,docsï¼‰
//func AutoGenRouteImport(moduleName, scanRoot, outputDir, matchDirs, ignoreDirs string) error {
//	// 1. å‚æ•°é»˜è®¤å€¼å¤„ç†
//	if scanRoot == "" {
//		var err error
//		scanRoot, err = os.Getwd() // è·å–å½“å‰å·¥ä½œç›®å½•
//		if err != nil {
//			return fmt.Errorf("è·å–å½“å‰ç›®å½•å¤±è´¥ï¼š%v", err)
//		}
//	}
//	if outputDir == "" {
//		outputDir = "routes" // é»˜è®¤ç”Ÿæˆåˆ°routesç›®å½•
//	}
//	if matchDirs == "" {
//		matchDirs = "test,lecture,handler,user"
//	}
//	if ignoreDirs == "" {
//		ignoreDirs = "vendor,testdata,docs,node_modules,.git,.idea"
//	}
//	if moduleName == "" {
//		return fmt.Errorf("moduleNameä¸èƒ½ä¸ºç©ºï¼ˆè¯·ä¼ å…¥ä¸šåŠ¡é¡¹ç›®çš„go moduleåï¼Œå¦‚pano-materialï¼‰")
//	}
//
//	// 2. åˆ›å»ºroutesç›®å½•ï¼ˆä¸å­˜åœ¨åˆ™åˆ›å»ºï¼‰
//	if err := os.MkdirAll(outputDir, 0755); err != nil {
//		return fmt.Errorf("åˆ›å»ºroutesç›®å½•å¤±è´¥ï¼š%v", err)
//	}
//
//	// 3. è§£æåŒ¹é…/å¿½ç•¥ç›®å½•è§„åˆ™
//	matchList := make(map[string]bool)
//	for _, dir := range filepath.SplitList(matchDirs) {
//		if dir != "" {
//			matchList[dir] = true
//		}
//	}
//	ignoreList := make(map[string]bool)
//	for _, dir := range filepath.SplitList(ignoreDirs) {
//		if dir != "" {
//			ignoreList[dir] = true
//		}
//	}
//
//	// 4. æ‰«æç›®å½•ï¼Œæ”¶é›†è·¯ç”±åŒ…
//	var routes []RouteGenInfo
//	err := filepath.Walk(scanRoot, func(path string, info os.FileInfo, err error) error {
//		if err != nil {
//			return err
//		}
//		// è·³è¿‡éç›®å½•ã€æ ¹ç›®å½•ã€å¿½ç•¥ç›®å½•
//		if !info.IsDir() || path == scanRoot || ignoreList[filepath.Base(path)] {
//			return nil
//		}
//		// åŒ¹é…æŒ‡å®šçš„è·¯ç”±ç›®å½•å…³é”®è¯
//		base := filepath.Base(path)
//		if matchList[base] {
//			// è½¬æ¢ä¸ºç›¸å¯¹è·¯å¾„ï¼ˆé¿å…ç»å¯¹è·¯å¾„ï¼‰
//			relPath, _ := filepath.Rel(scanRoot, path)
//			routes = append(routes, RouteGenInfo{
//				ModuleName: moduleName,
//				Path:       relPath,
//			})
//			fmt.Printf("[go-common] å‘ç°è·¯ç”±åŒ…ï¼š%s/%s\n", moduleName, relPath)
//		}
//		return nil
//	})
//	if err != nil {
//		return fmt.Errorf("æ‰«æè·¯ç”±ç›®å½•å¤±è´¥ï¼š%v", err)
//	}
//
//	// 5. ç”Ÿæˆå¯¼å…¥ä»£ç 
//	config := RouteGenConfig{
//		PackageName: filepath.Base(outputDir), // åŒ…åé»˜è®¤æ˜¯ç›®å½•åï¼ˆroutesï¼‰
//		Routes:      routes,
//	}
//	tpl, err := template.New("routeImport").Parse(routeImportTpl)
//	if err != nil {
//		return fmt.Errorf("è§£ææ¨¡æ¿å¤±è´¥ï¼š%v", err)
//	}
//	// 6. å†™å…¥auto_import.goæ–‡ä»¶
//	outputFile := filepath.Join(outputDir, "auto_import.go")
//	f, err := os.Create(outputFile)
//	if err != nil {
//		return fmt.Errorf("åˆ›å»ºauto_import.goå¤±è´¥ï¼š%v", err)
//	}
//	defer f.Close()
//
//	if err := tpl.Execute(f, config); err != nil {
//		return fmt.Errorf("ç”Ÿæˆauto_import.goå†…å®¹å¤±è´¥ï¼š%v", err)
//	}
//
//	fmt.Printf("[go-common] æˆåŠŸç”Ÿæˆè·¯ç”±å¯¼å…¥æ–‡ä»¶ï¼š%sï¼ˆå…±%dä¸ªè·¯ç”±åŒ…ï¼‰\n", outputFile, len(routes))
//	return nil
//}
